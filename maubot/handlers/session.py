"""–£–ø—Ä–∞–≤–ª—è–µ—Ç –∏–≥—Ä–æ–≤—ã–º–∏ —Å–µ—Å—Å–∏—è–º–∏.

–ü–æ–∑–≤–æ–ª—è–µ—Ç —Å–æ–∑–¥–∞–≤–∞—Ç—å –∫–æ–º–Ω–∞—Ç—ã, —É–¥–∞–ª—è—Ç—å –∏—Ö, –ø–µ—Ä–µ–∫–ª—é—á–∞—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏.
–ï—Å–ª–∏ –≤–∞—Å –∏–Ω—Ç–µ—Ä–µ—Å—É–µ—Ç –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏–π –∏–≥—Ä–æ–∫–æ–≤ –≤ —Å–µ—Å—Å–∏—è–º–∏, —Ç–æ –ø–µ—Ä–µ–π–¥–∏—Ç–µ
–≤ —Ä–æ—É—Ç–µ—Ä `player`.
"""

from aiogram import Router
from aiogram.filters import Command
from aiogram.types import Message

from maubot.messages import NO_ROOM_MESSAGE, NOT_ENOUGH_PLAYERS
from maubot import keyboards, stickers
from maubot.config import config
from maubot.messages import HELP_MESSAGE
from maubot.uno.exceptions import NoGameInChatError
from maubot.uno.game import UnoGame
from maubot.uno.session import SessionManager

router = Router(name="Sessions")


# –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏
# ===========

@router.message(Command("game"))
async def create_game(message: Message,
    sm: SessionManager,
    game: UnoGame | None
):
    """–°–æ–∑–¥–∞—ë—Ç –Ω–æ–≤—É—é –∫–æ–º–Ω–∞—Ç—É."""
    if message.chat.type == "private":
        return await message.answer("üëÄ –ò–≥—Ä—ã —Å–æ–∑–¥–∞—é—Ç—Å—è –≤ –≥—Ä—É–ø–ø–æ–≤–æ–º —á–∞—Ç–µ.")

    # –ï—Å–ª–∏ –∏–≥—Ä–∞ –µ—â—ë –Ω–µ –Ω–∞—á–∞–ª–∞—Å—å, –ø–æ–ª—É—á–∞–µ–º –µ—ë
    if game is None or game.started:
        game = sm.create(message.chat.id)
        game.start_player = message.from_user
        create_status = "‚òï <b>–°–æ–∑–¥–∞–Ω–æ –Ω–æ–≤–∞—è –∫–æ–º–Ω–∞—Ç–∞</b> –¥–ª—è –∏–≥—Ä—ã."
    else:
        create_status = "‚òï <b>–¢–µ–∫—É—â–∞—è –∫–æ–º–Ω–∞—Ç–∞</b> –¥–ª—è –∏–≥—Ä—ã."

    members_list = f"‚ú® –£—á–∞—Å—Ç–Ω–∏–∫–∏ ({len(game.players)}):\n"
    for player in game.players:
        members_list += f"- {player.user.mention_html()}\n"

    await message.answer((
        f"{create_status}\n"
        f"–ê–≤—Ç–æ—Ä: {game.start_player.mention_html()}\n\n{members_list}\n"
        "- /join —á—Ç–æ–±—ã –ø—Ä–∏—Å–æ–µ–¥–∏–Ω–∏—Ç—å—Å—è –∫ –∏–≥—Ä–µ\n"
        "- /start –¥–ª—è –Ω–∞—á–∞–ª–∞ –≤–µ—Å–µ–ª—å—è"
    ))

@router.message(Command("start"))
async def start_gama(message: Message, game: UnoGame | None):
    """–ó–∞–ø—É—Å–∫–∞–µ—Ç –∏–≥—Ä—É –≤ –∫–æ–º–Ω–∞—Ç–µ."""
    if message.chat.type == "private":
        return await message.answer(HELP_MESSAGE)

    if game is None:
        await message.answer(NO_ROOM_MESSAGE)

    elif game.started:
        await message.answer("üëÄ –ò–≥—Ä–∞ —É–∂–µ –Ω–∞—á–∞–ª–∞—Å—å.")

    elif len(game.players) < config.min_players:
        await message.answer9(NOT_ENOUGH_PLAYERS)

    else:
        game.start()
        await message.answer_sticker(
            stickers.NORMAL[stickers.to_str(game.deck.top)]
        )

        await message.answer((
                "üç∞ –î–∞ –Ω–∞—á–Ω—ë—Ç—Å—è <b>–ù–æ–≤–∞—è –∏–≥—Ä–∞!</b>!\n"
                f"–ò –ø–µ—Ä–≤—ã–º —É –Ω–∞—Å —Ö–æ–¥–∏—Ç {game.player.user.mention_html()}\n"
                "/close —á—Ç–æ–±—ã –∑–∞–∫—Ä—ã—Ç—å –∫–æ–º–Ω–∞—Ç—É –æ—Ç –ø–æ—Å—Ç–æ—Ä–æ–Ω–Ω–∏—Ö."
            ),
            reply_markup=keyboards.TURN_MARKUP
        )

@router.message(Command("stop"))
async def stop_gama(message: Message, game: UnoGame | None, sm: SessionManager):
    """–ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ –∑–∞–≤–µ—Ä—à–∞–µ—Ç —Ç–µ–∫—É—â—É—é –∏–≥—Ä—É."""
    if game is None:
        return await message.answer(NO_ROOM_MESSAGE)

    player = game.get_player(message.from_user.id)
    if player is None or player.user.id != game.start_player.id:
        return await message.answer(
            "üëÄ –¢–æ–ª—å–∫–æ —Å–æ–∑–¥–∞—Ç–µ–ª—å –∫–æ–º–Ω–∞—Ç—ã –º–æ–∂–µ—Ç –∑–∞–≤–µ—Ä—à–∏—Ç—å –∏–≥—Ä—É."
        )

    sm.remove(game.chat_id)
    await message.answer("üßπ –ò–≥—Ä–∞ –±—ã–ª–∞ –¥–æ–±—Ä–æ–≤–æ–ª—å–Ω–æ-–ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ –∑–∞–≤–µ—Ä—à–µ–Ω–∞.")


# –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞–º–∏ –∫–æ–º–Ω–∞—Ç—ã
# ==============================

@router.message(Command("open"))
async def open_gama(message: Message, game: UnoGame | None, sm: SessionManager):
    """–û—Ç–∫—Ä—ã–≤–∞–µ—Ç –∏–≥—Ä–æ–≤—É—é –∫–æ–º–Ω–∞—Ç—É –¥–ª—è –≤—Å–µ—Ö —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ —á–∞—Ç–∞."""
    if game is None:
        return await message.answer(NO_ROOM_MESSAGE)

    player = game.get_player(message.from_user.id)
    if player is None or player.user.id != game.start_player.id:
        return await message.answer(
            "üëÄ –¢–æ–ª—å–∫–æ —Å–æ–∑–¥–∞—Ç–µ–ª—å –∫–æ–º–Ω–∞—Ç—ã –º–æ–∂–µ—Ç –æ—Ç–∫—Ä—ã—Ç—å –∫–æ–º–Ω–∞—Ç—É."
        )

    game.open = True
    await message.answer(
        "üßπ –ö–æ–º–Ω–∞—Ç–∞ <b>–æ—Ç–∫—Ä—ã—Ç–∞</b>!\n –ª—é–±–æ–π —É—á–∞—Å—Ç–Ω–∏–∫ –º–æ–∂–µ—Ç –∑–∞–π—Ç–∏ (/join)."
    )

@router.message(Command("close"))
async def close_gama(message: Message,
    game: UnoGame | None,
    sm: SessionManager
):
    """–ó–∞–∫—Ä—ã–≤–∞–µ—Ç –∏–≥—Ä–æ–≤—É—é –∫–æ–º–Ω–∞—Ç—É –¥–ª—è –≤—Å–µ—Ö —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ —á–∞—Ç–∞."""
    if game is None:
        return await message.answer(NO_ROOM_MESSAGE)

    player = game.get_player(message.from_user.id)
    if player is None or player.user.id != game.start_player.id:
        return await message.answer(
            "üëÄ –¢–æ–ª—å–∫–æ —Å–æ–∑–¥–∞—Ç–µ–ª—å –∫–æ–º–Ω–∞—Ç—ã –º–æ–∂–µ—Ç –∑–∞–∫—Ä—ã—Ç—å –∫–æ–º–Ω–∞—Ç—É."
        )

    game.open = False
    await message.answer(
        "üßπ –ö–æ–º–Ω–∞—Ç–∞ <b>–∑–∞–∫—Ä—ã—Ç–∞</b>.\n–ù–∏–∫—Ç–æ –Ω–µ –ø–æ–º–µ—à–∞–µ—Ç –≤–∞–º –¥–æ–∏–≥—Ä–∞—Ç—å."
    )


# –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —É—á–∞—Å—Ç–Ω–∏–∫–∞–º–∏ –∫–æ–º–Ω–∞—Ç–∞–º–∏
# ================================

@router.message(Command("kick"))
async def kick_player(message: Message,
    game: UnoGame | None,
    sm: SessionManager
):
    """–í—ã–∫–∏–¥—ã–≤–∞–µ—Ç —É—á–∞—Å—Ç–Ω–∏–∫–∞ –∏–∑ –∫–æ–º–Ω–∞—Ç—ã."""
    if game is None:
        return await message.answer(NO_ROOM_MESSAGE)

    if not game.started:
        return await message.answer(
            "üç∞ –ò–≥—Ä–∞ –µ—â—ë –Ω–µ –Ω–∞—á–∞–ª–∞—Å—å, –ø–æ–∫–∞ —Ä–∞–Ω–æ –≤—ã–∫–∏–¥—ã–≤–∞—Ç—å —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤."
        )

    player = game.get_player(message.from_user.id)
    if player is None or player.user.id != game.start_player.id:
        return await message.answer(
            "üëÄ –¢–æ–ª—å–∫–æ —Å–æ–∑–¥–∞—Ç–µ–ª—å –∫–æ–º–Ω–∞—Ç—ã –º–æ–∂–µ—Ç –∑–∞–∫—Ä—ã—Ç—å –∫–æ–º–Ω–∞—Ç—É."
        )

    if message.reply_to_message is None:
        return await message.answer(
            "üëÄ –ü–µ—Ä–µ—à–ª–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –Ω–µ–≥–æ–¥–Ω–∏–∫–∞, –∫–æ—Ç–æ—Ä–æ–≥–æ –Ω—É–∂–Ω–æ –∏—Å–∫–ª—é—á–∏—Ç—å."
        )

    kicked_user = message.reply_to_message.from_user
    try:
        game.remove_player(kicked_user.id)
    except NoGameInChatError:
        return message.answer(
            "üëÄ –£–∫–∞–∑–∞–Ω–Ω—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –¥–∞–∂–µ –Ω–µ –∏–≥—Ä–∞–µ—Ç —Å –Ω–∞–º–∏."
        )

    status_message = (
        f"üßπ {game.start_player.mention_html()} –≤—ã–≥–Ω–∞–ª "
        f"{kicked_user.mention_html()} –∏–∑ –∏–≥—Ä—ã –∑–∞ –ø–ª–æ—Ö–æ–µ –ø–æ–≤–µ–¥–µ–Ω–∏–µ.\n"
    )
    if game.started:
        status_message += (
            "üç∞ –õ–∞–¥–Ω–µ–Ω—å–∫–æ, —Å–ª–µ–¥—É—é—â–∏—Ö —Ö–æ–¥ –∑–∞ "
            f"{game.player.user.mention_html()}."
        )
        markup = keyboards.TURN_MARKUP
    else:
        sm.remove(message.chat.id)
        status_message += NOT_ENOUGH_PLAYERS
        markup = None

    await message.answer(status_message, reply_markup=markup)
