"""–í—Å–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è –≤ –±–æ—Ç–µ, –¥–æ—Å—Ç—É–ø–Ω—ã–µ –≤ –æ–±—â–µ–º –¥–æ—Å—Ç—É–ø–µ.

–†–∞–∑–Ω—ã–µ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –º–æ–≥—É—Ç –ø–æ–ª—É—á–∏—Ç—å –¥–æ—Å—Ç—É–ø –∫ –¥–∞–Ω–Ω—ã–º —Å–æ–æ–±—â–µ–Ω–∏—è–º.
"""

from datetime import datetime

from maubot.config import config
from maubot.uno.game import RULES, UnoGame

# –°—Ç–∞—Ç–∏—á–µ—Å–∫–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è
# =====================

# –ö–æ–≥–¥–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–∏—à–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–µ /help
HELP_MESSAGE = (
    "üç∞ <b>–¢—Ä–∏ –ø—Ä–æ—Å—Ç—ã—Ö —à–∞–≥–∞ —á—Ç–æ–±—ã –Ω–∞—á–∞—Ç—å</b>:\n"
    "1. –î–æ–±–∞–≤—å—Ç–µ –±–æ—Ç–∞ –≤ –≥—Ä—É–ø–ø—É.\n"
    "2. –í –≥—Ä—É–ø–ø–µ –Ω–∞—á–Ω–∏—Ç–µ –Ω–æ–≤—É—é –∏–≥—Ä—É —á–µ—Ä–µ–∑ /game –∏–ª–∏ –ø–æ–¥–∫–ª—é—á–∏—Ç–µ—Å—å —á–µ—Ä–µ–∑ /join.\n"
    "3. –ï—Å–ª–∏ –≤–∞—Å –¥–≤–æ–µ –∏ –±–æ–ª—å—à–µ, –Ω–∞—á–∏–Ω–∞–π—Ç–µ –∏–≥—Ä—É –ø—Ä–∏ –ø–æ–º–æ—â–∏ /start!\n"
    "4. –í–≤–µ–¥–∏—Ç–µ <code>@mili_maubot</code> –≤ —á–∞—Ç–µ –∏–ª–∏ –∂–º—è–∫–Ω–∏—Ç–µ –Ω–∞ "
    "<code>via @mili_maubot</code>.\n"
    "–ó–¥–µ—Å—å –≤—Å–µ –≤–∞—à–∏ –∫–∞—Ä—Ç—ã, –∞ –µ—â—ë –∫–Ω–æ–ø–∫–∏ —á—Ç–æ–±—ã –≤–∑—è—Ç—å –∫–∞—Ä—Ç—ã –∏ –ø–æ—Å–º–æ—Ç—Ä–µ—Ç—å –∏–ª–∏ "
    "–ø—Ä–æ–≤–µ—Ä–∏—Ç—å —Ç–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∏–≥—Ä—ã.\n"
    "<b>–°–µ—Ä—ã–µ</b> –∫–∞—Ä—Ç—ã –≤—ã –ø–æ–∫–∞ –Ω–µ –º–æ–∂–µ—Ç–µ —Ä–∞–∑—ã–≥—Ä–∞—Ç—å.\n"
    "–ù–∞–∂–º–∏—Ç–µ –Ω–∞ –æ–¥–∏–Ω –∏–∑ —Å—Ç–∏–∫–µ—Ä–æ–≤, —á—Ç–æ–±—ã —Ä–∞–∑—ã–≥—Ä–∞—Ç—å –µ–≥–æ.\n\n"
    "–ò–≥—Ä–æ–∫–∏ –º–æ–≥—É—Ç –ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è –≤ –ª—é–±–æ–µ –≤—Ä–µ–º—è.\n"
    "–ß—Ç–æ–±—ã –ø–æ–∫–∏–Ω—É—Ç—å –∏–≥—Ä—É –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ /leave.\n"
    "–ï—Å–ª–∏ –∏–≥—Ä–æ–∫ –¥–æ–ª–≥–æ –¥—É–º–∞–µ—Ç. –µ–≥–æ –º–æ–∂–Ω–æ –ø—Ä–æ–ø—É—Å—Ç–∏—Ç—å –∫–æ–º–∞–Ω–¥–æ–π /skip.\n"
    "‚òï –û –ø—Ä–æ—á–∏—Ö –∫–æ–º–∞–Ω–¥–∞—Ö –º–æ–∂–Ω–æ —É–∑–Ω–∞—Ç—å –≤ <b>–º–µ–Ω—é</b>.\n"
)

# –†–∞—Å—Å–∫–∞–∑—ã–≤–∞–µ—Ç –æ–± –∞–≤—Ç–æ—Ä—Å—Ç–≤–µ –ø—Ä–æ–µ–∫—Ç–∞ –∏ –Ω–æ–≤–æ—Å—Ç–Ω–æ–º –∫–∞–Ω–∞–ª–µ
STATUS_MESSAGE = (
    "üåü <b>–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –±–æ—Ç–µ</b>:\n\n"
    "<b>Maubot</b> - Telegram –±–æ—Ç —Å –æ—Ç–∫—Ä—ã—Ç—ã–º –∏—Å—Ö–æ–¥–Ω—ã–º –∫–æ–¥–æ–º, –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è—é—â–∏–π "
    "–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º –∏–≥—Ä–∞—Ç—å –≤ Uno –≤ –≥—Ä—É–ø–ø–æ–≤—ã—Ö —á–∞—Ç–∞—Ö.\n"
    "–ò—Å—Ö–æ–¥–Ω—ã–π –∫–æ–¥ –ø—Ä–æ–µ–∫—Ç–∞ –¥–æ—Å—Ç—É–ø–µ–Ω –≤ "
    "<a href='https://codeberg.org/pentergust/maubot'>Codeberg</a>.\n"
    "–ú—ã –±—É–¥–µ–º –æ—á–µ–Ω—å —Ä–∞–¥—ã –µ—Å–ª–∏ –≤—ã –≤–Ω–µ—Å—ë—Ç–µ —Å–≤–æ–π –≤–∫–ª–∞–¥ –≤ —Ä–∞–∑–≤–∏—Ç–∏–µ –±–æ—Ç–∞. üçì\n\n"
    "–£–∑–Ω–∞—Ç—å –æ –≤—Å–µ—Ö –Ω–æ–≤–æ—Å—Ç—è—Ö –ø—Ä–æ–µ–∫—Ç–∞ –≤—ã –º–æ–∂–µ—Ç–µ –≤ Telegram –∫–∞–Ω–∞–ª–µ "
    "<a href='https://t.me/mili_qlaster'>Salorhard</a>."
)

# –ò–≥—Ä–æ–≤—ã–µ –∫–æ–º–Ω–∞—Ç—ã ------------------------------------------------------

# –ï—Å–ª–∏ –≤ –¥–∞–Ω–Ω–æ–º —á–∞—Ç–µ –µ—â—ë –Ω–µ —Å–æ–∑–¥–∞–Ω–æ –Ω–∏ –æ–¥–Ω–æ–π –∫–æ–º–Ω–∞—Ç—ã
NO_ROOM_MESSAGE = (
    "üëÄ –í –¥–∞–Ω–Ω–æ–º —á–∞—Ç–µ <b>–Ω–µ—Ç –∏–≥—Ä–æ–≤–æ–π –∫–æ–º–Ω–∞—Ç—ã</b>.\n"
    "–í—ã –º–æ–∂–µ—Ç–µ <b>—Å–æ–∑–¥–∞–π—Ç–µ –Ω–æ–≤—É—é</b> –ø—Ä–∏ –ø–æ–º–æ—â–∏ –∫–æ–º–∞–Ω–¥—ã /game."
)

# –ö–æ–≥–¥–∞ –Ω–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –∏–≥—Ä–æ–∫–æ–≤ –¥–ª—è –ø—Ä–æ–¥–æ–ª–∂–µ–Ω–∏—è –∏–≥—Ä—ã
NOT_ENOUGH_PLAYERS = (
    f"üç∞ <b>–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –∏–≥—Ä–æ–∫–æ–≤</b> (–º–∏–Ω–∏–º—É–º {config.min_players}) –¥–ª—è "
    "–∏–≥—Ä—ã.\n"
    "–ï—Å–ª–∏ –∏–≥—Ä–∞ <b>–Ω–µ –Ω–∞—á–∞–ª–∞—Å—å</b> –≤–æ—Å–ø–æ–ª—å–∑—É–π—Ç–µ—Å—å –∫–æ–º–∞–Ω–¥–æ–π "
    "/join —á—Ç–æ–±—ã –∑–∞–π—Ç–∏ –≤ –∫–æ–º–Ω–∞—Ç—É.\n"
    "–ò–ª–∏ —Å–æ–∑–¥–∞–π—Ç–µ –Ω–æ–≤—É—é –∫–æ–º–Ω–∞—Ç—É –ø—Ä–∏ –ø–æ–º–æ—â–∏ /start."
)

def get_closed_room_message(game: UnoGame) -> str:
    """–ö–æ–≥–¥–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø—ã—Ç–∞–µ—Ç—Å—è –ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è –≤ –∑–∞–∫—Ä—ã—Ç—É—é –∫–æ–º–Ω–∞—Ç—É."""
    return (
        "üîí –ö —Å–æ–∂–∞–ª–µ–Ω–∏—é –¥–∞–Ω–Ω–∞—è –∫–æ–º–Ω–∞—Ç–∞ <b>–∑–∞–∫—Ä—ã—Ç–∞</b>.\n"
        f"–í—ã –º–æ–∂–µ—Ç–µ –ø–æ–ø—Ä–æ—Å–∏—Ç—å {game.start_player.mention_html()} –æ—Ç–∫—Ä—ã—Ç—å"
        "–∫–æ–º–Ω–∞—Ç—É –∏–ª–∏ –¥–æ–∂–¥–∞—Ç—å—Å—è –∫–æ–≥–¥–∞ –∑–∞–≤–µ—Ä—à–∏—Ç—Å—è –∏–≥—Ä–∞."
    )


# –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏
# =======================

def plural_form(n: int, v: tuple[str, str, str]) -> str:
    """–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å–∫–ª–æ–Ω—ë–Ω–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —á–∏—Å–ª–∞.

    –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å–∫–ª–æ–Ω—ë–Ω–Ω–æ–µ —Å–ª–æ–≤–æ: "–¥–ª—è –æ–¥–Ω–æ–≥–æ", "–¥–ª—è –¥–≤—É—Ö",
    "–¥–ª—è –ø—è—Ç–∏" –∑–Ω–∞—á–µ–Ω–∏–π.
    """
    return v[2 if (4 < n % 100 < 20) else (2, 0, 1, 1, 1, 2)[min(n % 10, 5)]] #noqa

def get_str_timedelta(seconds: int):
    """–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å—Ç—Ä–æ–∫–æ–≤–æ–µ –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–∏ –∏–∑ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ —Å–µ–∫—É–Ω–¥."""
    m, s = divmod(seconds, 60)
    if m == 0:
        return f"{s} {plural_form(m, ('—Å–µ–∫—É–Ω–¥—É', "—Å–µ–∫—É–Ω–¥—ã", '—Å–µ–∫—É–Ω–¥'))}" 
    if s == 0:
        return f"{m} {plural_form(m, ('–º–∏–Ω—É—Ç—É', "–º–∏–Ω—É—Ç—ã", '–º–∏–Ω—É—Ç'))}"
    return (
        f"{m} {plural_form(m, ('–º–∏–Ω—É—Ç—É', "–º–∏–Ω—É—Ç—ã", '–º–∏–Ω—É—Ç'))} –∏ "
        f"{s} {plural_form(m, ('—Å–µ–∫—É–Ω–¥—É', "—Å–µ–∫—É–Ω–¥—ã", '—Å–µ–∫—É–Ω–¥'))}"
    )


# –î–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è
#  =====================

def get_room_rules(game: UnoGame) -> str:
    """–ü–æ–ª—É—á–∞–µ—Ç –≤–∫–ª—é—á–µ–Ω–Ω—ã–µ –∏–≥—Ä–æ–≤—ã–µ –ø—Ä–∞–≤–∏–ª–∞ –¥–ª—è —Ç–µ–∫—É—â–µ–π –∫–æ–º–Ω–∞—Ç—ã."""
    rule_list = ""
    active_rules = 0
    for rule in RULES:
        status = getattr(game.rules, rule.key, False)
        if status:
            active_rules += 1
            rule_list += f"\n- {rule.name}"

    if active_rules == 0:
        return ""
    return f"üî• –í—ã–±—Ä–∞–Ω–Ω—ã–µ –ø—Ä–∞–≤–∏–ª–∞ {active_rules}:{rule_list}"

def get_room_players(game: UnoGame) -> str:
    """–°–æ–±–∏—Ä–∞–µ—Ç —Å–ø–∏—Å–æ–∫ –∏–≥—Ä–æ–∫–æ–≤ –¥–ª—è —Ç–µ–∫—É—â–µ–π –∫–æ–º–Ω–∞—Ç—ã."""
    if len(game.players) == 0:
        return "‚ú® –í –∫–æ–º–Ω–∞—Ç–µ –ø–æ–∫–∞ –Ω–∏–∫–æ–≥–æ –Ω–µ—Ç—É.\n"
    
    reverse_sim = "üî∫" if game.reverse else "üîª"
    players_list = f"‚ú® –£—á–∞—Å—Ç–Ω–∏–∫–∏ ({len(game.players)}{reverse_sim}):\n"
    for i, player in enumerate(game.players):
        if i == game.current_player:
            players_list += (
                f"- <b>{player.user.mention_html()}</b> "
                f"({len(player.hand)} –∫–∞—Ä—Ç)\n"
            )
        else:
            players_list += (
                f"- {player.user.mention_html()} "
                f"({len(player.hand)} –∫–∞—Ä—Ç)\n"
            )
    return players_list


def get_new_game_message(game: UnoGame) -> str:
    """–°–æ–æ–±—â–µ–Ω–∏–µ –æ –Ω–∞—á–∞–ª–µ –Ω–æ–≤–æ–π –∏–≥—Ä—ã –≤ –∫–æ–º–Ω–∞—Ç–µ."""
    return (
        "üç∞ –î–∞ –Ω–∞—á–Ω—ë—Ç—Å—è <b>–ù–æ–≤–∞—è –∏–≥—Ä–∞!</b>!\n"
        f"–ò –ø–µ—Ä–≤—ã–º —É –Ω–∞—Å —Ö–æ–¥–∏—Ç {game.player.user.mention_html()}\n"
        "/close —á—Ç–æ–±—ã –∑–∞–∫—Ä—ã—Ç—å –∫–æ–º–Ω–∞—Ç—É –æ—Ç –ø–æ—Å—Ç–æ—Ä–æ–Ω–Ω–∏—Ö.\n\n"
        f"{get_room_rules(game)}"
    )

def get_room_status(game: UnoGame) -> str:
    """–û—Ç–æ–±—Ä–∞–∂–∞–µ—Ç —Å—Ç–∞—Ç—É—Å —Ç–µ–∫—É—â–µ–π –∫–æ–º–Ω–∞—Ç—ã."""
    if not game.started:
        return (
            f"‚òï –ù–æ–≤–∞—è <b>–ò–≥—Ä–æ–≤–∞—è –∫–æ–º–Ω–∞—Ç–∞</b>!\n"
            f"<b>–°–æ–∑–¥–∞–ª</b>: {game.start_player.mention_html()}\n\n"
            f"{get_room_players(game)}\n"
            "‚öôÔ∏è <b>–ø—Ä–∞–≤–∏–ª–∞</b> –ø–æ–∑–≤–æ–ª—è—é—Ç —Å–¥–µ–ª–∞—Ç—å –∏–≥—Ä—É –±–æ–ª–µ–µ –≤–µ—Å—ë–ª–æ–π."
            "- /join —á—Ç–æ–±—ã –ø—Ä–∏—Å–æ–µ–¥–∏–Ω–∏—Ç—å—Å—è –∫ –∏–≥—Ä–µ\n"
            "- /start –¥–ª—è –Ω–∞—á–∞–ª–∞ –≤–µ—Å–µ–ª—å—è!üç∞"
        )
    now = datetime.now()
    game_delta = get_str_timedelta(int((now - game.game_start).total_seconds()))
    turn_delta = get_str_timedelta(int((now - game.turn_start).total_seconds()))
    return (
        f"‚òï <b>–ò–≥—Ä–æ–≤–∞—è –∫–æ–º–Ω–∞—Ç–∞</b> {game.start_player.first_name}:\n"
        f"üÉè <b>–ü–æ—Å–ª–µ–¥–Ω—è—è –∫–∞—Ä—Ç–∞</b>: {game.deck.top}\n"
        f"ü¶ù <b>–°–µ–π—á–∞—Å —Ö–æ–¥</b> {game.player.user.first_name} "
        f"(–ø—Ä–æ—à–ª–æ {turn_delta})\n\n"
        f"{get_room_players(game)}\n"
        f"{get_room_rules(game)}\n"
        f"‚è≥ <b>–ò–≥—Ä–∞ –¥–ª–∏—Ç—Å—è</b> {game_delta}"
    )
