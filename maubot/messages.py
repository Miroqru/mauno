"""–í—Å–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è –≤ –±–æ—Ç–µ, –¥–æ—Å—Ç—É–ø–Ω—ã–µ –≤ –æ–±—â–µ–º –¥–æ—Å—Ç—É–ø–µ.

–†–∞–∑–Ω—ã–µ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –º–æ–≥—É—Ç –ø–æ–ª—É—á–∏—Ç—å –¥–æ—Å—Ç—É–ø –∫ –¥–∞–Ω–Ω—ã–º —Å–æ–æ–±—â–µ–Ω–∏—è–º.
–ó–¥–µ—Å—å –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω—ã –∫–∞–∫ —Å—Ç–∞—Ç–∏—á–µ—Å–∫–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è, —Ç–∞–∫ –∏ –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–µ.
"""

from datetime import datetime

from mau import exceptions
from mau.game.game import UnoGame
from mau.game.player_manager import PlayerManager

# –ö–æ–≥–¥–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–∏—à–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–µ /help
# –ù–µ–º–Ω–æ–≥–æ —Ä–∞—Å—Å–∫–∞–∑—ã–≤–∞–µ—Ç –ø—Ä–æ –±–æ—Ç–∞ –∏ –∫–∞–∫ –∏–º –ø–æ–ª—å–∑–æ–≤–∞—Ç—å—Å—è
HELP_MESSAGE = (
    "üç∞ <b>–¢—Ä–∏ –ø—Ä–æ—Å—Ç—ã—Ö —à–∞–≥–∞ —á—Ç–æ–±—ã –Ω–∞—á–∞—Ç—å –≤–µ—Å–µ–ª—å–µ</b>!\n\n"
    "1. –î–æ–±–∞–≤—å—Ç–µ –±–æ—Ç–∞ –≤ –≤–∞—à—É –≥—Ä—É–ø–ø—É.\n"
    "2. –í –≥—Ä—É–ø–ø–µ —Å–æ–∑–¥–∞–π—Ç–µ –∫–æ–º–Ω–∞—Ç—É —á–µ—Ä–µ–∑ /game –∏–ª–∏ –∑–∞–π–¥–∏—Ç–µ –≤ –Ω–µ—ë —á–µ—Ä–µ–∑ /join.\n"
    "3. –ö–∞–∫ —Ç–æ–ª—å–∫–æ –≤—Å–µ —Å–æ–±—Ä–∞–ª–∏—Å—å, –Ω–∞—á–∏–Ω–∞–π—Ç–µ –∏–≥—Ä—É –ø—Ä–∏ –ø–æ–º–æ—â–∏ /start!\n"
    "4. –í–≤–µ–¥–∏—Ç–µ <code>@mili_maubot</code> –≤ —á–∞—Ç–µ –∏–ª–∏ –∂–º—è–∫–Ω–∏—Ç–µ –Ω–∞ –∫–Ω–æ–ø–∫—É —Ö–æ–¥–∞.\n"
    "–ó–¥–µ—Å—å –≤—Å–µ –≤–∞—à–∏ –∫–∞—Ä—Ç—ã, –∞ –µ—â—ë –∫–Ω–æ–ø–∫–∏ —á—Ç–æ–±—ã –≤–∑—è—Ç—å –∫–∞—Ä—Ç—ã –∏ "
    "–ø—Ä–æ–≤–µ—Ä–∏—Ç—å —Ç–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∏–≥—Ä—ã.\n"
    "<b>–°–µ—Ä—ã–µ</b> –∫–∞—Ä—Ç—ã –≤—ã –ø–æ–∫–∞ –Ω–µ –º–æ–∂–µ—Ç–µ —Ä–∞–∑—ã–≥—Ä–∞—Ç—å.\n"
    "–ù–∞–∂–º–∏—Ç–µ –Ω–∞ –æ–¥–∏–Ω –∏–∑ —Å—Ç–∏–∫–µ—Ä–æ–≤ –∫–∞—Ä—Ç—ã, —á—Ç–æ–±—ã —Ä–∞–∑—ã–≥—Ä–∞—Ç—å –µ—ë.\n\n"
    "üå≥ –ò–≥—Ä–æ–∫–∏ –º–æ–≥—É—Ç –ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è –≤ –ª—é–±–æ–µ –≤—Ä–µ–º—è.\n"
    "–ï—Å–ª–∏ –Ω–µ —Ö–æ—Ç–∏—Ç–µ —á—Ç–æ–±—ã –≤–∞–º –ø–æ–º–µ—à–∞–ª–∏, –∑–∞–∫—Ä–æ–π—Ç–µ –∫–æ–º–Ω–∞—Ç—É —á–µ—Ä–µ–∑ /close.\n"
    "–ß—Ç–æ–±—ã –ø–æ–∫–∏–Ω—É—Ç—å –∏–≥—Ä—É –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ /leave.\n"
    "–ï—Å–ª–∏ –∏–≥—Ä–æ–∫ –¥–æ–ª–≥–æ –¥—É–º–∞–µ—Ç. –µ–≥–æ –º–æ–∂–Ω–æ –ø—Ä–æ–ø—É—Å—Ç–∏—Ç—å –∫–æ–º–∞–Ω–¥–æ–π /skip.\n"
    "‚òï –û –ø—Ä–æ—á–∏—Ö –∫–æ–º–∞–Ω–¥–∞—Ö –º–æ–∂–Ω–æ —É–∑–Ω–∞—Ç—å –≤ <b>–º–µ–Ω—é</b>.\n"
)

# –ò–≥—Ä–æ–≤—ã–µ –∫–æ–º–Ω–∞—Ç—ã ------------------------------------------------------

# TODO: –ü–µ—Ä–µ–º–µ—Å—Ç–∏–º
# –ï—Å–ª–∏ –≤ –¥–∞–Ω–Ω–æ–º —á–∞—Ç–µ –µ—â—ë –Ω–µ —Å–æ–∑–¥–∞–Ω–æ –Ω–∏ –æ–¥–Ω–æ–π –∫–æ–º–Ω–∞—Ç—ã
NO_ROOM_MESSAGE = (
    "üëÄ –í –¥–∞–Ω–Ω–æ–º —á–∞—Ç–µ –µ—â—ë <b>–Ω–µ—Ç –∏–≥—Ä–æ–≤–æ–π –∫–æ–º–Ω–∞—Ç—ã</b>.\n"
    "üç∞ –í—ã –º–æ–∂–µ—Ç–µ <b>—Å–æ–∑–¥–∞–π—Ç–µ –Ω–æ–≤—É—é</b> –ø—Ä–∏ –ø–æ–º–æ—â–∏ –∫–æ–º–∞–Ω–¥—ã /game."
)


# –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏
# =======================


def plural_form(n: int, v: tuple[str, str, str]) -> str:
    """–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å–∫–ª–æ–Ω—ë–Ω–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —á–∏—Å–ª–∞.

    –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å–∫–ª–æ–Ω—ë–Ω–Ω–æ–µ —Å–ª–æ–≤–æ: "–¥–ª—è –æ–¥–Ω–æ–≥–æ", "–¥–ª—è –¥–≤—É—Ö",
    "–¥–ª—è –ø—è—Ç–∏" –∑–Ω–∞—á–µ–Ω–∏–π.
    """
    return v[2 if (4 < n % 100 < 20) else (2, 0, 1, 1, 1, 2)[min(n % 10, 5)]]  # noqa: PLR2004


def time_delta(seconds: int) -> str:
    """–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å—Ç—Ä–æ–∫–æ–≤–æ–µ –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–∏ –∏–∑ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ —Å–µ–∫—É–Ω–¥.

    –ú–æ–¥–∏—Ñ–∏–∫–∞—Ç–æ—Ä –≤—Ä–µ–º–µ–Ω–∏ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–∫–ª–æ–Ω—è–µ—Ç—Å—è –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –≤—Ä–µ–º–µ–Ω–∏.
    """
    h, r = divmod(seconds, 3600)
    m, s = divmod(r, 60)
    res = ""

    if h != 0:
        res += f"{m} {plural_form(m, ('—á–∞—Å', '—á–∞—Å–∞', '—á–∞—Å–æ–≤'))} "
    if m != 0:
        res += f"{m} {plural_form(m, ('–º–∏–Ω—É—Ç—É', '–º–∏–Ω—É—Ç—ã', '–º–∏–Ω—É—Ç'))} "
    if s != 0:
        res += f"{s} {plural_form(m, ('—Å–µ–∫—É–Ω–¥—É', '—Å–µ–∫—É–Ω–¥—ã', '—Å–µ–∫—É–Ω–¥'))}"
    return res


_MEDALS = ("ü•á", "ü•à", "ü•â")


def place_medal(i: int) -> str | None:
    """–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –º–µ–¥–∞–ª—å –∑–∞ –º–µ—Å—Ç–æ –≤ —Ä–µ–π—Ç–∏–Ω–≥–µ."""
    return _MEDALS[i] if i < len(_MEDALS) else None


# –î–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è
# ======================


def game_rules_list(game: UnoGame) -> str:
    """–ü–æ–ª—É—á–∞–µ—Ç –≤–∫–ª—é—á–µ–Ω–Ω—ã–µ –∏–≥—Ä–æ–≤—ã–µ –ø—Ä–∞–≤–∏–ª–∞ –¥–ª—è —Ç–µ–∫—É—â–µ–π –∫–æ–º–Ω–∞—Ç—ã.

    –û—Ç–æ–±—Ä–∞–∂–∞–µ—Ç —Å–ø–∏—Å–æ–∫ –ø—Ä–∞–≤–∏–ª –∏ –æ–±—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –≤–∫–ª—é—á–µ–Ω–Ω—ã—Ö –ø—Ä–∞–≤–∏–ª.
    –ï—Å–ª–∏ –Ω–∏—á–µ–≥–æ –Ω–µ –≤—ã–±—Ä–∞–Ω–æ, —Ç–æ –≤–µ—Ä–Ω—ë—Ç –ø—É—Å—Ç—É—é —Å—Ç—Ä–æ–∫—É.
    """
    rule_list = ""
    for name, status in game.rules.iter_rules():
        if status:
            rule_list += f"- {name}\n"
    return f"ü™Ñ –ò–≥—Ä–æ–≤—ã–µ –ø—Ä–∞–≤–∏–ª–∞\n:{rule_list}" if rule_list != "" else ""


def players_list(pm: PlayerManager, reverse: bool, shotgun: bool) -> str:
    """–°–ø–∏—Å–æ–∫ –∏–≥—Ä–æ–∫–æ–≤ –¥–ª—è —Ç–µ–∫—É—â–µ–π –∫–æ–º–Ω–∞—Ç—ã.

    –û—Ç–æ–±—Ä–∞–∂–∞–µ—Ç –ø–æ—Ä—è–¥–æ–∫ —Ö–æ–¥–∞, —Å–ø–∏—Å–æ–∫ –≤—Å–µ—Ö –∏–≥—Ä–æ–∫–æ–≤.
    –ê–∫—Ç–∏–≤–Ω–æ–≥–æ –∏–≥—Ä–æ–∫–∞ –ø–æ–º–µ—á–∞–µ—Ç –∂–∏—Ä–Ω—ã–º —à—Ä–∏—Ñ—Ç–æ–º.
    –¢–∞–∫–∂–µ —É–∫–∞–∑—ã–≤–∞–µ—Ç –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∫–∞—Ä—Ç –∏ –≤—ã—Å—Ç—Ä–µ–ª–æ–≤ –∏–∑ —Ä–µ–≤–æ–ª—å–≤–µ—Ä–∞.
    """
    reverse_sim = "‚óÄÔ∏è" if reverse else "‚ñ∂Ô∏è"
    res = f"‚ú® –ò–≥—Ä–æ–∫–∏ {reverse_sim}:\n"
    for i, player in enumerate(pm.iter()):
        shotgun_stat = f" {player.shotgun.cur} / 8 üî´" if shotgun else ""
        name = f"<b>{player.name}</b>" if player == pm.current else player.name
        res += f"- {name} üÉè{len(player.hand)} {shotgun_stat}\n"
    return res


def game_status(game: UnoGame) -> str:
    """–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å—Ç–∞—Ç—É—Å —Ç–µ–∫—É—â–µ–π –∏–≥—Ä—ã.

    –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –∏ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –Ω–æ–≤–æ–π –∫–æ–º–Ω–∞—Ç—ã.
    –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç —Å–ø–∏—Å–æ–∫ –∏–≥—Ä–æ–∫–æ–≤ –∏ –ø–æ–ª–µ–∑–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã.

    –ï—Å–ª–∏ –∏–≥—Ä–∞ —É–∂–µ –Ω–∞—á–∞–ª–∞—Å—å, —Ç–æ –¥–æ–±–∞–≤–ª—è–µ—Ç—Å—è —Å–∞–º–∞—è —Ä–∞–∑–Ω–∞ –ø–æ–ª–µ–∑–Ω–∞—è
    –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Ç–µ–∫—É—â–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–∏ –∏–≥—Ä—ã.
    –ö–∞–∫ –º–∏–Ω–∏–º—É–º —Å–ø–∏—Å–æ–∫ –∏–≥—Ä–æ–∫–æ–≤, –≤—ã–±—Ä–∞–Ω–Ω—ã–µ —Ä–µ–∂–∏–º—ã, –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∫–∞—Ä—Ç –∏ —Ç–∞–∫
    –¥–∞–ª–µ–µ.
    """
    if not game.started:
        room_players = ", ".join(pl.name for pl in game.pm.iter())
        return (
            f"‚òï <b>–ò–≥—Ä–æ–≤–∞—è –∫–æ–º–Ω–∞—Ç–∞</b> {game.owner.name}!\n"
            f"‚ú® –≤—Å–µ–≥–æ –∏–≥—Ä–æ–∫–æ–≤ {len(game.pm)}:\n{room_players}\n"
            "ü™Ñ –ò–≥—Ä–æ–≤—ã–µ <b>–ø—Ä–∞–≤–∏–ª–∞</b> –ø–æ–∑–≤–æ–ª—è—é—Ç —Å–¥–µ–ª–∞—Ç—å –∏–≥—Ä—É –±–æ–ª–µ–µ –≤–µ—Å—ë–ª–æ–π.\n"
            "üçâ –í—Ä–µ–º—è –ø—Ä–∏—Å–æ–µ–¥–∏–Ω–∏—Ç—å—Å—è –∫ –∏–≥—Ä–µ!"
        )

    if game.rules.single_shotgun.status:
        shotgun_stats = f"üî´ <b>–†–µ–≤–æ–ª—å–≤–µ—Ä</b>: {game.shotgun.cur} / 8"
    else:
        shotgun_stats = ""

    now = datetime.now()
    game_delta = time_delta(int((now - game.game_start).total_seconds()))
    turn_delta = time_delta(int((now - game.turn_start).total_seconds()))
    return (
        f"‚òï <b>–ò–≥—Ä–æ–≤–∞—è –∫–æ–º–Ω–∞—Ç–∞</b> {game.owner.name}:\n"
        f"üÉè <b>–ü–æ—Å–ª–µ–¥–Ω—è—è –∫–∞—Ä—Ç–∞</b>: {game.deck.top}\n"
        f"ü¶ù <b>–•–æ–¥</b> {game.player.name}, –ø—Ä–æ—à–ª–æ {turn_delta}\n"
        f"‚è≥ <b>–ò–≥—Ä–∞ –∏–¥—ë—Ç</b> {game_delta}\n\n"
        f"{players_list(game.pm, game.reverse, game.rules.shotgun.status)}\n"
        f"{game_rules_list(game)}"
        f"üì¶ <b>–∫–∞—Ä—Ç</b> –≤ –∫–æ–ª–æ–¥–µ: {len(game.deck.cards)} –¥–æ—Å—Ç—É–ø–Ω–æ / "
        f"{len(game.deck.used_cards)} –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–æ.\n{shotgun_stats}"
    )


def describe_error(exc: Exception) -> str:
    """–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–± –æ—à–∏–±–∫–µ."""
    if isinstance(exc, exceptions.NoGameInChatError):
        return NO_ROOM_MESSAGE

    if isinstance(exc, exceptions.LobbyClosedError):
        return (
            "üîí –ö —Å–æ–∂–∞–ª–µ–Ω–∏—é –¥–∞–Ω–Ω–∞—è –∫–æ–º–Ω–∞—Ç–∞ <b>–∑–∞–∫—Ä—ã—Ç–∞</b>.\n"
            "–í—ã –º–æ–∂–µ—Ç–µ –ø–æ–ø—Ä–æ—Å–∏—Ç—å –≤–ª–∞–¥–µ–ª—å—Ü–∞ –∫–æ–º–Ω–∞—Ç—ã –æ—Ç–∫—Ä—ã—Ç—å"
            "–∫–æ–º–Ω–∞—Ç—É –∏–ª–∏ –¥–æ–∂–¥–∞—Ç—å—Å—è –æ–∫–æ–Ω—á–∞–Ω–∏—è –∏–≥—Ä–∞."
        )

    return f"üëÄ <b>–ß—Ç–æ-—Ç–æ –ø–æ—à–ª–æ –Ω–µ –ø–æ –ø–ª–∞–Ω—É</b>...\n{exc}"


def end_game_players(pm: PlayerManager) -> str:
    """–°–æ–æ–±—â–µ–Ω–∏–µ –æ–± –æ–∫–æ–Ω—á–∞–Ω–∏–∏ –∏–≥—Ä—ã.

    –°–æ–¥–µ—Ä–∂–∏—Ç —Å–ø–∏—Å–æ–∫ –ø–æ–±–µ–¥–∏—Ç–µ–ª–µ–π –∏ –ø—Ä–æ–∏–≥—Ä–∞–≤—à–∏—Ö.
    """
    res = "üéâ <b>–ò–≥—Ä–∞ –∑–∞–≤–µ—Ä—à–∏–ª–∞—Å—å</b>!\n"
    for i, winner in enumerate(pm.iter(pm.winners)):
        res += f"{place_medal(i) or f'{i + 1}'}. {winner.name}\n"
    res += "\nüéÄ –ü—Ä–æ–∏–≥—Ä–∞–≤—à–∏–µ:\n"
    for i, loser in enumerate(pm.iter(pm.losers)):
        res += f"{i + 1}. {loser.name}\n"
    return res
